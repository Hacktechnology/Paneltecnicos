<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacktechnology Pro - v9.0</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">

    <style>
        :root { --am: #ffcc00; --az: #0033ab; --ro: #ff0000; --bg: #0f0f0f; --card: #1a1a1a; --green: #25D366; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: #e0e0e0; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .header-box { text-align: center; margin-bottom: 20px; width: 100%; max-width: 400px; }
        .brand { font-size: 28px; font-weight: 900; letter-spacing: -1px; margin: 0; }
        .t-am { color: var(--am); } .t-az { color: var(--az); } .t-ro { color: var(--ro); }
        .subtitle { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; font-weight: 600; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; width: 100%; max-width: 400px; border: 1px solid #333; box-sizing: border-box; margin-bottom: 10px; text-align: center; position: relative; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #444; border-radius: 8px; background-color: #252525; color: white; outline: none; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-go { background: var(--green); color: white; }
        .btn-blue { background: var(--az); color: white; }
        .btn-ghost { background: #333; color: #fff; border: 1px solid #444; }
        .btn-del { background: var(--ro); color: white; padding: 10px; width: auto; font-size: 14px; margin: 0; border-radius: 8px; }
        .admin-section { border-top: 1px solid #333; padding-top: 15px; margin-top: 15px; text-align: left; }
        .scroll-area { max-height: 250px; overflow-y: auto; margin-top: 10px; border-radius: 8px; background: #000; padding: 10px; }
        .item-list { background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--az); display: flex; justify-content: space-between; align-items: center; }
        .item-list.finalizado { border-left-color: var(--green); }
        .check-center { font-size: 20px; color: var(--green); flex-grow: 1; text-align: center; }
        .badge { background: var(--az); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .footer { font-size: 10px; color: #555; margin: 20px 0; text-align: center; width: 100%; }
        .hidden { display: none !important; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading { animation: spin 1s linear infinite; display: inline-block; }
    </style>
</head>
<body>

    <div class="header-box">
        <h1 class="brand">
            <span class="t-am">HACK</span><span class="t-az">TECH</span><span class="t-ro">NOLOGY</span>
        </h1>
        <div class="subtitle">Seguridad Inform√°tica ‚Ä¢ T√©cnicos Pro</div>
    </div>

    <div id="p-login" class="card">
        <input type="text" id="user-input" placeholder="Usuario">
        <input type="password" id="pass-input" placeholder="Clave">
        <button class="btn-go" onclick="ejecutarLogin()">INGRESAR</button>
        <button class="btn-ghost" onclick="showScreen('p-admin-auth')">‚öôÔ∏è PANEL MAESTRO</button>
    </div>

    <div id="p-tecnico" class="card hidden">
        <h3 class="t-am">T√©cnico: <span id="display-user" style="color:white"></span></h3>
        <div class="admin-section">
            <label>üìã TAREAS ASIGNADAS</label>
            <button class="btn-ghost" id="btn-refresh-tec" onclick="getSheetsData()">üîÑ ACTUALIZAR LISTA</button>
            <div id="list-tecnico" class="scroll-area"></div>
        </div>
        <div class="admin-section">
            <label>üìù CIERRE DE TRABAJO</label>
            <input type="text" id="cli-name" placeholder="Nombre del Cliente">
            <input type="tel" id="cli-phone" placeholder="WhatsApp Cliente">
            <input type="text" id="tkt-val" placeholder="N√∫mero Ticket">
            <input type="number" id="costo-val" placeholder="Costo del Servicio ($)">
            <textarea id="sol-val" rows="3" placeholder="Descripci√≥n de la soluci√≥n..."></textarea>
            <input type="hidden" id="row-id">
            <button class="btn-go" id="btn-send" onclick="sendWhatsApp()">ENVIAR Y NOTIFICAR ‚úÖ</button>
            <button class="btn-ghost" onclick="window.location.reload()">SALIR</button>
        </div>
    </div>

    <div id="p-maestro" class="card hidden">
        <h2 class="t-az">Administraci√≥n</h2>
        <div class="admin-section">
            <label>üìë ASIGNACI√ìN <span id="count-pends" class="badge">0</span></label>
            <button class="btn-ghost" id="btn-refresh-master" onclick="getMasterExcel()">üîÑ CARGAR PENDIENTES</button>
            <div id="list-master-excel" class="scroll-area"></div>
        </div>
        <div class="admin-section">
            <label>üîê GESTI√ìN DE PERSONAL Y CLAVES</label>
            <div id="personal-keys-inputs"></div>
            <button class="btn-blue" id="btn-save-staff" onclick="savePersonalKeys()">GUARDAR CAMBIOS</button>
        </div>
        <button class="btn-ghost" onclick="window.location.reload()">‚¨ÖÔ∏è VOLVER</button>
    </div>

    <div id="p-admin-auth" class="card hidden">
        <h3 class="t-az">Seguridad Maestro</h3>
        <input type="password" id="m-key" placeholder="Clave de Acceso">
        <button class="btn-blue" onclick="verificarMaestro()">ENTRAR</button>
        <button class="btn-ghost" onclick="showScreen('p-login')">VOLVER</button>
    </div>

    <div class="footer">
        ¬© 2026 Hacktechnology - Todos los derechos reservados.
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdxxc64bUVzEGbKWTRRKAoDhHGLFZ3yfibL-4yLgFywQa3EN15PCtGGWBfySdRCKdr/exec";
    
    let db = JSON.parse(localStorage.getItem('hackDB_v5')) || {
        personal: [{ nombre: "GEOMAR", clave: "1234" }]
    };

    function showScreen(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function ejecutarLogin() {
        const u = document.getElementById('user-input').value.trim().toUpperCase();
        const p = document.getElementById('pass-input').value.trim();
        const found = db.personal.find(t => t.nombre.toUpperCase() === u && t.clave === p);
        if(found) {
            document.getElementById('display-user').innerText = u;
            showScreen('p-tecnico');
            getSheetsData();
        } else { alert("Usuario o clave incorrecta"); }
    }

    function verificarMaestro() {
        if(document.getElementById('m-key').value === "admin99") {
            showScreen('p-maestro');
            loadPersonalSettings();
            getMasterExcel();
        } else { alert("Acceso denegado"); }
    }

    async function getSheetsData() {
        const btn = document.getElementById('btn-refresh-tec');
        btn.innerHTML = '<span class="loading">üîÑ</span> CARGANDO...';
        const list = document.getElementById('list-tecnico');
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            const user = document.getElementById('display-user').innerText;
            const tasks = data.filter(t => t.tecnico && t.tecnico.toUpperCase() === user);
            
            list.innerHTML = tasks.map(t => {
                const tktLimpio = String(t.ticket).replace(/HT-/g, '');
                const esFinalizado = (t.status === "FINALIZADO");
                return `
                <div class="item-list ${esFinalizado ? 'finalizado' : ''}">
                    <div style="text-align:left;">
                        <b style="color:var(--am)">HT-${tktLimpio}</b><br>
                        <small>${t.cliente}</small>
                    </div>
                    ${esFinalizado ? '<div class="check-center">‚úîÔ∏è</div>' : ''}
                    ${!esFinalizado ? `<button onclick="fillForm('${t.cliente}', '${tktLimpio}', '${t.fila}')" style="width:auto; padding:8px 12px; background:var(--az); color:white; border-radius:6px; font-size:11px;">USAR</button>` : '<div style="width:60px;"></div>'}
                </div>`;
            }).join('') || "Sin tareas asignadas.";
        } catch(e) { list.innerHTML = "Error de red."; }
        btn.innerHTML = "üîÑ ACTUALIZAR LISTA";
    }

    function fillForm(cliente, ticket, fila) {
        document.getElementById('cli-name').value = cliente;
        document.getElementById('tkt-val').value = `HT-${ticket}`;
        document.getElementById('row-id').value = fila;
        document.getElementById('cli-name').focus();
    }

    async function sendWhatsApp() {
        const btn = document.getElementById('btn-send');
        const cli = document.getElementById('cli-name').value;
        const tktFull = document.getElementById('tkt-val').value;
        const cost = document.getElementById('costo-val').value;
        const sol = document.getElementById('sol-val').value;
        const row = document.getElementById('row-id').value;
        const phone = document.getElementById('cli-phone').value.replace(/\D/g,'');

        if(!cli || !tktFull || !cost || !phone) return alert("Complete los datos obligatorios.");

        btn.disabled = true;
        btn.innerText = "REGISTRANDO...";

        if(row) {
            await fetch(SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ numFila: row, finalizar: true, solucion: sol, costo: cost }) 
            });
        }

        const mensaje = `*HACKTECHNOLOGY*%0A*REPORTE DE SERVICIO*%0A%0A*Ticket:* ${tktFull}%0A*Cliente:* ${cli}%0A*Trabajo:* ${sol}%0A*Costo:* $${cost}%0A%0A¬°Su equipo est√° listo para retirar! ‚úÖ`;
        window.open(`https://wa.me/58${phone}?text=${mensaje}`, '_blank');
        
        alert("Reporte guardado con √©xito.");
        getSheetsData();
        btn.disabled = false;
        btn.innerText = "ENVIAR Y NOTIFICAR ‚úÖ";
        
        document.getElementById('cli-name').value = "";
        document.getElementById('tkt-val').value = "";
        document.getElementById('costo-val').value = "";
        document.getElementById('sol-val').value = "";
    }

    async function getMasterExcel() {
        const btn = document.getElementById('btn-refresh-master');
        btn.innerHTML = '<span class="loading">üîÑ</span>...';
        const list = document.getElementById('list-master-excel');
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            const pends = data.filter(t => !t.tecnico || t.tecnico.trim() === "");
            document.getElementById('count-pends').innerText = pends.length;
            
            list.innerHTML = pends.map(t => {
                const tktLimpio = String(t.ticket).replace(/HT-/g, '');
                return `
                <div class="item-list" style="display:block; text-align:left;">
                    <b>HT-${tktLimpio}</b> - ${t.cliente}
                    <select id="sel-${t.fila}" style="margin-top:5px;">
                        ${db.personal.map(tec => `<option value="${tec.nombre}">${tec.nombre}</option>`).join('')}
                    </select>
                    <button onclick="assignTec(${t.fila})" class="btn-blue" style="padding:8px; font-size:11px; margin-top:5px; width:100%;">ASIGNAR</button>
                </div>`;
            }).join('') || "No hay tickets pendientes.";
        } catch(e) { list.innerHTML = "Error."; }
        btn.innerHTML = "üîÑ CARGAR PENDIENTES";
    }

    async function assignTec(fila) {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ numFila: fila, nombreTecnico: document.getElementById(`sel-${fila}`).value }) });
        alert("Asignado correctamente.");
        getMasterExcel();
    }

    function loadPersonalSettings() {
        const cont = document.getElementById('personal-keys-inputs');
        cont.innerHTML = db.personal.map((t, i) => `
            <div style="display:flex; gap:5px; margin-bottom:8px; align-items:center;">
                <input type="text" id="name-${i}" placeholder="Nombre" value="${t.nombre}" style="margin:0; flex:1;">
                <input type="text" id="key-${i}" placeholder="Clave" value="${t.clave}" style="margin:0; flex:1; border-color: var(--az);">
                <button class="btn-del" onclick="removeTecRow(${i})">‚úï</button>
            </div>`).join('') + `<button class="btn-ghost" onclick="addTecRow()" style="padding:8px; font-size:13px;">+ A√±adir T√©cnico</button>`;
    }

    function addTecRow() { db.personal.push({ nombre: "", clave: "" }); loadPersonalSettings(); }
    function removeTecRow(i) { if(confirm("¬øEliminar acceso?")) { db.personal.splice(i, 1); loadPersonalSettings(); } }

    function savePersonalKeys() {
        const btn = document.getElementById('btn-save-staff');
        const newP = [];
        db.personal.forEach((_, i) => {
            const n = document.getElementById(`name-${i}`).value.trim().toUpperCase();
            const k = document.getElementById(`key-${i}`).value.trim();
            if(n && k) newP.push({ nombre: n, clave: k });
        });
        db.personal = newP;
        localStorage.setItem('hackDB_v5', JSON.stringify(db));
        btn.innerText = "DATOS GUARDADOS ‚úÖ";
        btn.style.background = "var(--green)";
        setTimeout(() => { btn.innerText = "GUARDAR CAMBIOS"; btn.style.background = "var(--az)"; }, 2000);
    }
</script>
</body>
</html>
